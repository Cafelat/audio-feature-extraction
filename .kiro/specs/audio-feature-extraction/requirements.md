# 要件定義: 音声特徴量抽出モジュール及びデータセットジェネレータ

## 概要

本機能は、音声データから機械学習に必要な特徴量を抽出し、標準的なデータセット形式で出力するモジュールを提供します。研究者やエンジニアが音声認識・音声合成・音声分析などのタスクに取り組む際、データ前処理の負担を軽減し、実験の再現性を高めることを目的としています。

**リアルタイム処理対応**: ストリーミング音声データに対応し、オンライン推論や音声合成にも利用可能な設計とします。各処理段階の状態を直感的に理解でき、振幅・位相情報を適切に保持することで、高品質な逆変換（音声再構成）を実現します。

### 背景
- 音声機械学習プロジェクトでは、前処理と特徴量抽出が共通の課題
- 手作業での特徴量抽出は時間がかかり、エラーが発生しやすい
- 標準化されたパイプラインがあれば、実験の再現性と効率が向上
- リアルタイム処理や音声合成タスクでは、位相情報の保持と高品質な逆変換が重要

## 機能要件

### FR-1: 音声ファイル読み込み
- **FR-1.1**: 一般的な音声フォーマット（WAV, FLAC, MP3, OGG）のサポート
- **FR-1.2**: バッチ処理: ディレクトリ内の複数音声ファイルの一括読み込み
- **FR-1.3**: サンプリングレート変換（リサンプリング）機能
- **FR-1.4**: モノラル/ステレオ対応、チャンネル選択機能
- **FR-1.5**: ストリーミング対応: チャンクベースのリアルタイム音声入力処理

### FR-2: 特徴量抽出
- **FR-2.1**: スペクトログラム（STFT）抽出
  - 複素数スペクトログラム（振幅 + 位相）
  - dBスケール振幅スペクトログラム
  - 位相スペクトログラム（ラジアン）
  - FFTサイズ、ホップ長、窓関数を設定可能
  - データ形状: `(time, frequency, channels)` - channels は [magnitude_db, phase] 等
- **FR-2.2**: メルスペクトログラム抽出
  - dBスケールメル振幅スペクトログラム
  - メルフィルタバンク数を設定可能
  - オプション: メル領域での位相情報保持
- **FR-2.3**: MFCC（Mel-Frequency Cepstral Coefficients）抽出
  - MFCC係数数、デルタ・デルタデルタの算出オプション
- **FR-2.4**: Chroma特徴量抽出
- **FR-2.5**: Zero Crossing Rate, Spectral Centroid等の基本的な音響特徴量
- **FR-2.6**: 拡張性: カスタム特徴量抽出関数の登録機能

### FR-3: 逆変換（音声再構成）
- **FR-3.1**: ISTFT（Inverse Short-Time Fourier Transform）
  - 振幅・位相スペクトログラムから音声波形を再構成
  - 完全な可逆変換（元の位相情報を使用）
  - リアルタイム処理対応（Overlap-Add法）
- **FR-3.2**: Griffin-Lim アルゴリズム
  - 振幅スペクトログラムのみから位相を推定して音声再構成
  - 反復回数、収束判定の設定可能
- **FR-3.3**: 逆変換時の品質管理
  - クリッピング防止
  - 出力音声の正規化オプション

### FR-4: データ前処理
- **FR-4.1**: 音声正規化（振幅正規化）
- **FR-4.2**: トリミング（無音区間除去）
- **FR-4.3**: パディング（固定長への調整）
- **FR-4.4**: データ拡張（Data Augmentation）オプション
  - ピッチシフト
  - タイムストレッチ
  - ノイズ付加

### FR-5: データセット生成
- **FR-5.1**: メタデータ管理: ファイル名、ラベル、特徴量パラメータの記録
- **FR-5.2**: データセット分割: Train/Validation/Test split機能
- **FR-5.3**: 出力フォーマット
  - NumPy形式（.npy, .npz）
  - HDF5形式
  - PyTorch Dataset互換形式
  - JSON/CSVメタデータ
- **FR-5.4**: 増分更新: 既存データセットへの追加機能
- **FR-5.5**: マルチチャンネルデータ保存
  - 振幅・位相を別チャンネルとして保存
  - データ形状とメタデータの明示的な記録

### FR-6: パイプライン設定
- **FR-6.1**: YAML/JSON形式の設定ファイル対応
- **FR-6.2**: CLIインターフェース
  - コマンドライン引数での主要パラメータ指定
  - 設定ファイルパス指定
- **FR-6.3**: プログラマティックAPI: Pythonコードからの利用
- **FR-6.4**: ステートフル処理パイプライン
  - 各処理段階の中間状態を明示的に保持
  - パイプラインの可視化・デバッグ機能

### FR-7: ログとモニタリング
- **FR-7.1**: 処理進捗表示（プログレスバー）
- **FR-7.2**: エラーハンドリングとログ出力
- **FR-7.3**: 処理統計情報の出力（処理時間、ファイル数、特徴量サイズ等）
- **FR-7.4**: リアルタイム処理時のレイテンシモニタリング

## 非機能要件

### NFR-1: パフォーマンス
- **NFR-1.1**: GPU加速サポート（CUDA 12.8）
  - PyTorch/CuPy等を使用した高速処理
- **NFR-1.2**: マルチスレッド/マルチプロセス処理による並列化
- **NFR-1.3**: 大規模データセット対応
  - メモリ効率的なバッチ処理
  - 1,000ファイル以上の処理が現実的な時間で完了すること
- **NFR-1.4**: リアルタイム処理性能
  - 低レイテンシ: チャンク処理で100ms以下の遅延
  - ストリーミング対応: 継続的な音声入力の処理
  - Overlap-Add法による連続処理

### NFR-2: 拡張性
- **NFR-2.1**: プラグインアーキテクチャ
  - カスタム特徴量抽出器の追加が容易
  - カスタムデータ拡張の追加が容易
- **NFR-2.2**: モジュール設計
  - 各処理ステップが独立したモジュールとして分離
  - 部分的な機能の再利用が可能
  - **直感的な状態管理**: 各モジュールの入出力データ形状を明確に定義
  - **型安全性**: データクラスやProtocolを使った明示的なインターフェース

### NFR-3: 可読性・保守性
- **NFR-3.1**: 直感的なモジュール命名
  - 処理内容が名前から理解できる
  - 一貫した命名規則（例: `AudioLoader`, `STFTExtractor`, `ISTFTReconstructor`）
- **NFR-3.2**: 状態の可視化
  - 中間データの形状・型を明示
  - デバッグ時の状態確認機能
- **NFR-3.3**: データフロー図との対応
  - コード構造とデータフローの対応が明確

### NFR-4: 可用性
- **NFR-4.1**: エラー回復: 処理中断時の再開機能（チェックポイント）
- **NFR-4.2**: 入力バリデーション: 不正な設定値の検出とエラーメッセージ

### NFR-5: 保守性
- **NFR-5.1**: コードドキュメント
  - すべての公開API関数にdocstring
  - Type hints必須
- **NFR-5.2**: テストカバレッジ: 80%以上
- **NFR-5.3**: PEP 8準拠

### NFR-6: ユーザビリティ
- **NFR-6.1**: わかりやすいエラーメッセージ
- **NFR-6.2**: 実用的なサンプルコードとドキュメント
- **NFR-6.3**: デフォルト設定での動作

## 制約事項

### 技術的制約
- **TC-1**: Python 3.13環境
- **TC-2**: CUDA 12.8互換のGPU（オプショナル、CPU fallback必須）
- **TC-3**: 依存ライブラリ
  - librosa: 音声処理
  - PyTorch: GPU加速・深層学習フレームワーク
  - NumPy, SciPy: 数値計算
  - soundfile: 音声ファイルI/O

### 運用制約
- **OC-1**: 大規模データセット処理時のディスク容量（入力の数倍必要）
- **OC-2**: GPU利用時はCUDA対応GPUとドライバが必要
- **OC-3**: リアルタイム処理時のメモリ制約
  - チャンクサイズとバッファリング戦略の適切な設定が必要

### 互換性制約
- **CC-1**: 既存の音声データセット形式との互換性
  - Common Voice, LibriSpeech等の一般的なデータセット構造との親和性
- **CC-2**: 音声処理ライブラリとの互換性
  - librosa, torchaudioとのデータ形式互換性

## 成功基準

### 機能達成基準
- **SC-1**: STFT特徴量（振幅・位相スペクトログラム）の抽出が正常に動作
- **SC-2**: ISTFT逆変換による音声再構成が正常に動作
- **SC-3**: Griffin-Limアルゴリズムによる音声再構成が正常に動作
- **SC-4**: 設定ファイルとCLIの両方からパイプライン実行可能
- **SC-5**: 最低3種類の出力フォーマット（NumPy, HDF5, PyTorch Dataset）に対応
- **SC-6**: サンプル音声データでEnd-to-Endのデータセット生成が成功
- **SC-7**: リアルタイム処理（チャンク処理）が正常に動作

### パフォーマンス基準
- **SC-8**: GPU使用時、CPU比で3倍以上の高速化
- **SC-9**: 100ファイル（合計10分の音声）の処理が1分以内（GPU使用時）
- **SC-10**: リアルタイム処理時のレイテンシが100ms以下

### 品質基準
- **SC-11**: ユニットテストカバレッジ80%以上
- **SC-12**: 統合テスト: サンプルデータセットでの完全なワークフロー検証
- **SC-13**: 逆変換品質: ISTFT後の音声が原音と高い類似性を持つ（SNR > 30dB）
- **SC-14**: Linter（ruff/black）チェック通過

### ドキュメント基準
- **SC-15**: README: セットアップ手順、基本的な使い方、サンプルコード
- **SC-16**: API Documentation: 全公開関数のdocstring
- **SC-17**: チュートリアル: 最低1つの実用的なend-to-endサンプル（逆変換含む）
- **SC-18**: モジュール構造図: データフローと各モジュールの役割を図示

## 優先順位

### P0（必須）
- FR-1: 音声ファイル読み込み（基本フォーマット対応）
- FR-2.1: STFT抽出（振幅・位相スペクトログラム、dBスケール対応）
- FR-3.1: ISTFT逆変換
- FR-5: データセット生成（NumPy形式、マルチチャンネル対応）
- FR-6: パイプライン設定（CLI基本機能）
- NFR-3: 直感的なモジュール設計・状態管理

### P1（高優先度）
- FR-1.5: ストリーミング・リアルタイム処理
- FR-2.2: メルスペクトログラム抽出
- FR-3.2: Griffin-Lim逆変換
- FR-4: データ前処理（正規化、トリミング、パディング）
- FR-5.3: HDF5形式出力
- FR-7: ログとモニタリング（レイテンシモニタリング含む）
- NFR-1: GPU加速
- NFR-1.4: リアルタイム処理性能

### P2（中優先度）
- FR-2.3: MFCC抽出
- FR-2.4-2.5: その他の特徴量（Chroma, ZCR, Spectral Centroid）
- FR-4.4: データ拡張
- FR-5.2: データセット分割
- FR-6.1: YAML設定ファイル
- FR-6.4: ステートフル処理パイプライン可視化

### P3（低優先度）
- FR-2.6: カスタム特徴量抽出器
- FR-5.4: 増分更新
- NFR-4.1: エラー回復機能（チェックポイント）

---

**ステータス**: 要件定義フェーズ - 更新完了  
**作成日**: 2026-01-19  
**更新日**: 2026-01-19T07:12:37.430Z  
**変更内容**: リアルタイム処理対応、振幅・位相スペクトログラム、ISTFT逆変換、直感的なモジュール設計を追加  
**次のステップ**: 要件を確認し、承認後に `/kiro-spec-design audio-feature-extraction` で設計フェーズへ進んでください
